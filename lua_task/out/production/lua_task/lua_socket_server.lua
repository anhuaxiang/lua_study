---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2018/10/23 16:50
---

local socket = require("socket")
local host = "127.0.0.1"
local port = "8888"
local client_tab = {}
local conn_cout = 0

local server = socket.bind(host, port, 1024)
server:settimeout(0)
print("server start " .. host .. ":" .. port)


while true do
    local conn = server:accept()
    if conn then
        conn_cout = conn_cout + 1
        client_tab[conn_cout] = conn
        print("a client successfully connect")
    end

    for conn_cout, client in pairs(client_tab) do
        local recvt, sendt, status = socket.select({client}, nil, 1)
        if #recvt > 0 then
            local receive, receive_status = client:receive()
            if receive_status ~= "close" then
                if receive then
                    client:send("client " .. conn_cout .. "  send: ")
                    client:send(receive .. "\n")
                    print("receive client " .. conn_cout .. ":", receive)
                end
            else
                table.remove(client_tab, conn_cout)
                client:close()
                print("client " .. conn_cout .. "closed")
            end
        end
    end
end

